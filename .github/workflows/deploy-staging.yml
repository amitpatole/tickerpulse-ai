name: Deploy Staging

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      image-tag: ${{ steps.tag.outputs.value }}

    steps:
      - name: Checkout CI-validated commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Compute image tag
        id: tag
        run: echo "value=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT

      - name: Deploy to staging environment
        run: |
          install -m 600 /dev/null ~/.ssh/id_deploy
          printf '%s' "$DEPLOY_TOKEN" > ~/.ssh/id_deploy
          ssh -i ~/.ssh/id_deploy \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "$DEPLOY_USER@$DEPLOY_HOST" \
              "set -e
               cd /opt/tickerpulse-staging
               git fetch --quiet
               git checkout ${{ github.event.workflow_run.head_sha }}
               docker compose pull --quiet
               docker compose up -d --remove-orphans
               echo 'Staging deploy complete: ${{ github.event.workflow_run.head_sha }}'"
        env:
          DEPLOY_TOKEN: ${{ secrets.STAGING_DEPLOY_TOKEN }}
          DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
          DEPLOY_USER: ${{ secrets.STAGING_USER }}

  staging-smoke:
    name: Staging Smoke Tests
    needs: [deploy-staging]
    runs-on: ubuntu-latest

    steps:
      - name: Validate STAGING_BASE_URL is configured
        run: |
          if [ -z "$STAGING_BASE_URL" ]; then
            echo "STAGING_BASE_URL is not configured â€” add it to repository variables"
            exit 1
          fi
          echo "Running smoke tests against $STAGING_BASE_URL"
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Health check
        run: curl -f "$STAGING_BASE_URL/api/health"
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Watchlist endpoint check
        run: curl -f "$STAGING_BASE_URL/api/watchlist"
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Stocks endpoint check
        run: curl -f "$STAGING_BASE_URL/api/stocks"
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Earnings endpoint check
        run: curl -f "$STAGING_BASE_URL/api/earnings"
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Portfolio endpoint check
        run: curl -f "$STAGING_BASE_URL/api/portfolio" || true
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}

      - name: Chat health check
        run: curl -f "$STAGING_BASE_URL/api/chat/health" || true
        env:
          STAGING_BASE_URL: ${{ vars.STAGING_BASE_URL }}